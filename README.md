<p align="center">
  <a href="http://nestjs.com/" target="blank"><img src="https://nestjs.com/img/logo-small.svg" width="120" alt="Nest Logo" /></a>
</p>

<p align="center">
  <h1 align="center">API de Gest√£o de Chamados Multi-Tenant com Sistema de Franquias</h1>
</p>

<p align="center">Uma API robusta para gerenciamento de tickets/chamados de suporte com arquitetura multi-tenant hier√°rquica para franquias, desenvolvida com <a href="http://nestjs.com/" target="_blank">NestJS</a>, <a href="https://www.prisma.io/" target="_blank">Prisma</a> e <a href="https://www.postgresql.org/" target="_blank">PostgreSQL</a>.</p>

<p align="center">
  <a href="https://www.npmjs.com/~nestjscore" target="_blank"><img src="https://img.shields.io/npm/v/@nestjs/core.svg" alt="NPM Version" /></a>
  <a href="https://www.npmjs.com/~nestjscore" target="_blank"><img src="https://img.shields.io/npm/l/@nestjs/core.svg" alt="Package License" /></a>
</p>

## üìã Descri√ß√£o

Esta API fornece um sistema completo de gest√£o de chamados/tickets de suporte **multi-tenant hier√°rquico** especificamente projetado para **sistemas de franquias**, permitindo:

- **üè¢ Arquitetura Multi-Tenant via Param de Rota** - Tenants identificados por slug na URL
- **üîê Autentica√ß√£o por Tenant Slug** - Login contextual por tenant
- **üè∑Ô∏è Segmenta√ß√£o por Mercado** - MODA, FOOD, FARMA, TECH, BEAUTY, SPORT
- **üëë Controle Total Crown** - Administra√ß√£o global com sele√ß√£o de marca/segmento
- **üé´ Gest√£o Completa de Chamados** - Sistema robusto de tickets com filtros hier√°rquicos
- **üìä BI e Relat√≥rios Hier√°rquicos** - Visibilidade baseada na estrutura de franquias
- **üöÄ Escalabilidade com Docker/Kubernetes** - Infraestrutura pronta para produ√ß√£o

## üèóÔ∏è Arquitetura Multi-Tenant via Param de Rota

### üîó Estrutura de URLs por Tenant

```
https://api.example.com/
‚îú‚îÄ‚îÄ /lacoste/auth/login          # Login na Lacoste
‚îú‚îÄ‚îÄ /lacoste/tickets             # Tickets da Lacoste
‚îú‚îÄ‚îÄ /nike/auth/login             # Login na Nike
‚îú‚îÄ‚îÄ /nike/tickets                # Tickets da Nike
‚îú‚îÄ‚îÄ /mcdonalds/auth/login        # Login no McDonald's
‚îî‚îÄ‚îÄ /mcdonalds/tickets           # Tickets do McDonald's
```

### üéØ Funcionamento do Sistema

#### 1. **Identifica√ß√£o do Tenant**
- O tenant √© identificado pelo **slug** na URL (ex: `/lacoste/...`)
- O sistema valida automaticamente se o tenant existe e est√° ativo
- Todas as opera√ß√µes s√£o isoladas por tenant

#### 2. **Autentica√ß√£o Contextual**
- **Login**: `POST /:tenant/auth/login`
- **Perfil**: `GET /:tenant/auth/me`
- **Tokens JWT** incluem informa√ß√µes do tenant
- **Valida√ß√£o autom√°tica** de correspond√™ncia entre JWT e tenant da URL

#### 3. **Opera√ß√µes com Tickets**
- **Criar**: `POST /:tenant/tickets`
- **Listar**: `GET /:tenant/tickets`
- **Visualizar**: `GET /:tenant/tickets/:id`
- **Atualizar**: `PATCH /:tenant/tickets/:id`
- **Excluir**: `DELETE /:tenant/tickets/:id`
- **Estat√≠sticas**: `GET /:tenant/tickets/stats`

#### 4. **Opera√ß√µes com Categorias de Tickets**
- **Criar**: `POST /:tenant/ticket-category`
- **Listar Todas**: `GET /:tenant/ticket-category`
- **Listar Ativas**: `GET /:tenant/ticket-category/active`
- **Visualizar**: `GET /:tenant/ticket-category/:id`
- **Atualizar**: `PATCH /:tenant/ticket-category/:id`
- **Excluir**: `DELETE /:tenant/ticket-category/:id`

### üîê Seguran√ßa e Isolamento

#### **Guard Global TenantContextGuard**
- Intercepta todas as requisi√ß√µes
- Extrai o tenant slug da URL
- Valida exist√™ncia e status do tenant
- Injeta contexto do tenant na requisi√ß√£o

#### **Valida√ß√£o de JWT**
- Verifica se o token JWT corresponde ao tenant da URL
- Impede acesso cruzado entre tenants
- Garante isolamento total de dados

### üé® Exemplos de Uso

#### **1. Login em um Tenant**
```bash
# Login na Lacoste
curl -X POST "http://localhost:3010/lacoste/auth/login" \
  -H "Content-Type: application/json" \
  -d '{
    "email": "admin@lacoste.com",
    "password": "senha123"
  }'
```

#### **2. Listar Tickets do Tenant**
```bash
# Listar tickets da Lacoste
curl -X GET "http://localhost:3010/lacoste/tickets" \
  -H "Authorization: Bearer SEU_JWT_TOKEN"
```

#### **3. Criar Ticket no Tenant**
```bash
# Criar ticket na Nike
curl -X POST "http://localhost:3010/nike/tickets" \
  -H "Authorization: Bearer SEU_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "title": "Problema no Sistema",
    "description": "Descri√ß√£o do problema",
    "categoryId": "uuid-da-categoria",
    "priority": "HIGH"
  }'
```

#### **4. Gerenciar Categorias de Tickets**
```bash
# Criar categoria
curl -X POST "http://localhost:3010/nike/ticket-category" \
  -H "Authorization: Bearer SEU_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Suporte T√©cnico",
    "description": "Problemas t√©cnicos e suporte ao sistema",
    "color": "#FF5722",
    "icon": "support",
    "slaHours": 24
  }'

# Listar categorias ativas
curl -X GET "http://localhost:3010/nike/ticket-category/active" \
  -H "Authorization: Bearer SEU_JWT_TOKEN"
```

## üîß Componentes Principais

### **TenantContextGuard**
- Guard global que intercepta todas as requisi√ß√µes
- Extrai tenant slug da URL
- Valida tenant no banco de dados
- Injeta contexto do tenant na requisi√ß√£o

### **AuthController**
- Rota: `/:tenant/auth/*`
- Login contextual por tenant
- Valida√ß√£o de correspond√™ncia JWT/tenant

### **TicketController**
- Rota: `/:tenant/tickets/*`
- Opera√ß√µes CRUD isoladas por tenant
- Filtros autom√°ticos por tenant

### **TicketCategoryController**
- Rota: `/:tenant/ticket-category/*`
- Gerenciamento de categorias de tickets
- Valida√ß√µes de nome √∫nico por tenant
- Soft delete para categorias em uso
- Personaliza√ß√£o com cores e √≠cones
- SLA configur√°vel por categoria

### **JWT Strategy**
- Valida√ß√£o de tokens JWT
- Verifica√ß√£o de correspond√™ncia com tenant
- Controle de acesso contextual

## üìä Modelo de Dados

### Tickets

O sistema permite a organiza√ß√£o dos tickets em categorias personaliz√°veis por tenant, com as seguintes caracter√≠sticas:

#### Campos
- **name**: Nome √∫nico da categoria (por tenant)
- **description**: Descri√ß√£o detalhada (opcional)
- **color**: Cor em formato hexadecimal para UI (opcional)
- **icon**: Nome do √≠cone para UI (opcional)
- **isActive**: Status de ativa√ß√£o da categoria
- **slaHours**: Tempo de SLA em horas (1-720h, opcional)

#### Valida√ß√µes
- Nome √∫nico por tenant
- Cor em formato hexadecimal v√°lido (ex: #FF5722)
- SLA entre 1 e 720 horas (30 dias)
- Soft delete para categorias com tickets associados

#### Relacionamentos
- Pertence a um Tenant espec√≠fico
- Pode ter m√∫ltiplos Tickets associados

#### Exemplo de Categoria
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "name": "Suporte T√©cnico",
  "description": "Tickets relacionados a problemas t√©cnicos",
  "color": "#FF5722",
  "icon": "support",
  "slaHours": 24,
  "isActive": true,
  "tenantId": "tenant-uuid",
  "createdAt": "2024-01-01T00:00:00.000Z",
  "updatedAt": "2024-01-01T00:00:00.000Z"
}
```

## üõ†Ô∏è Tecnologias Utilizadas

- **[NestJS](https://nestjs.com/)** - Framework Node.js progressivo
- **[Prisma](https://www.prisma.io/)** - ORM moderno com suporte a hierarquias
- **[PostgreSQL](https://www.postgresql.org/)** - Banco de dados relacional
- **[JWT](https://jwt.io/)** - Autentica√ß√£o contextual
- **[Swagger](https://swagger.io/)** - Documenta√ß√£o interativa
- **[Docker](https://www.docker.com/)** - Containeriza√ß√£o
- **[Kubernetes](https://kubernetes.io/)** - Orquestra√ß√£o de containers

## üì¶ Instala√ß√£o

### Pr√©-requisitos
- Node.js (vers√£o 18 ou superior)
- pnpm (gerenciador de pacotes)
- PostgreSQL
- Docker (opcional)

### Configura√ß√£o do Projeto

1. **Clone o reposit√≥rio**
```bash
git clone <url-do-repositorio>
cd data_intelligence_api
```

2. **Instale as depend√™ncias**
```bash
pnpm install
```

3. **Inicie o PostgreSQL com Docker**
```bash
docker-compose up -d postgres redis
```

4. **Configure as vari√°veis de ambiente**
```bash
# Crie um arquivo .env com as seguintes vari√°veis:
DATABASE_URL="postgresql://tickets:tickets_secure_pass@localhost:5432/tickets_db?schema=public"
JWT_SECRET="super_secure_jwt_secret_for_production"
JWT_EXPIRES_IN="7d"
PORT=3010
NODE_ENV=development
REDIS_URL="redis://localhost:6379"
```

5. **Execute as migra√ß√µes do banco**
```bash
npx prisma db push
```

6. **Gere o cliente Prisma**
```bash
npx prisma generate
```

## üöÄ Executando a Aplica√ß√£o

### Desenvolvimento
```bash
# Com vari√°veis de ambiente inline
DATABASE_URL="postgresql://tickets:tickets_secure_pass@localhost:5432/tickets_db?schema=public" \
JWT_SECRET="super_secure_jwt_secret_for_production" \
JWT_EXPIRES_IN="7d" \
PORT=3010 \
npm run start:dev
```

### Produ√ß√£o
```bash
# Com Docker Compose (recomendado)
docker-compose up -d

# Ou manualmente
npm run build
npm run start:prod
```

A API estar√° dispon√≠vel em `http://localhost:3010`

## üìñ Documenta√ß√£o da API

Ap√≥s iniciar a aplica√ß√£o, acesse a documenta√ß√£o interativa do Swagger em:
```
http://localhost:3010/docs
```

## üß™ Testando a API Multi-Tenant

### 1. Verificar Status da API
```bash
curl http://localhost:3010/
# Resposta: Hello World!
```

### 2. Listar Tenants Dispon√≠veis
```bash
curl http://localhost:3010/tenants
```

### 3. Login em um Tenant Espec√≠fico
```bash
# Login na Lacoste
curl -X POST "http://localhost:3010/lacoste/auth/login" \
  -H "Content-Type: application/json" \
  -d '{
    "email": "admin@lacoste.com",
    "password": "senha123"
  }'
```

### 4. Acessar Tickets do Tenant
```bash
# Listar tickets da Lacoste (com token obtido no login)
curl -X GET "http://localhost:3010/lacoste/tickets" \
  -H "Authorization: Bearer SEU_JWT_TOKEN"
```

### 5. Criar Ticket no Tenant
```bash
# Criar ticket na Nike
curl -X POST "http://localhost:3010/nike/tickets" \
  -H "Authorization: Bearer SEU_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "title": "Problema no Sistema",
    "description": "Descri√ß√£o detalhada do problema",
    "categoryId": "uuid-da-categoria",
    "priority": "HIGH"
  }'
```

### 6. Obter Estat√≠sticas do Tenant
```bash
# Estat√≠sticas dos tickets da Lacoste
curl -X GET "http://localhost:3010/lacoste/tickets/stats" \
  -H "Authorization: Bearer SEU_JWT_TOKEN"
```

## üîÑ Migra√ß√µes e Mudan√ßas

### Vers√£o 2.0 - Multi-Tenant via Param de Rota

#### **Principais Mudan√ßas:**
1. **Rota de Login**: `POST /:tenant/auth/login`
2. **Remo√ß√£o do CNPJ**: Login agora usa apenas email/password
3. **TenantContextGuard**: Guard global para valida√ß√£o de tenant
4. **JWT Contextual**: Tokens incluem informa√ß√µes do tenant
5. **Rotas Contextuais**: Todas as rotas incluem tenant slug

#### **Benef√≠cios:**
- ‚úÖ **URLs mais intuitivas** e organizadas
- ‚úÖ **Isolamento autom√°tico** por tenant
- ‚úÖ **Seguran√ßa aprimorada** com valida√ß√£o cruzada
- ‚úÖ **Melhor experi√™ncia** para desenvolvedores
- ‚úÖ **Escalabilidade** para m√∫ltiplos tenants

## üèóÔ∏è Arquitetura do Sistema de Franquias

### üîó Hierarquia de Tenants

```
üëë CROWN (Crown Company) - /crown/*
‚îú‚îÄ‚îÄ üè¨ FRANQUEADOR (Lacoste Matriz) - /lacoste-matriz/*
‚îÇ   ‚îú‚îÄ‚îÄ üè™ FRANQUIA (Lacoste Loja Shopping) - /lacoste-shopping/*
‚îÇ   ‚îî‚îÄ‚îÄ üè™ FRANQUIA (Lacoste Loja Centro) - /lacoste-centro/*
‚îú‚îÄ‚îÄ üè¨ FRANQUEADOR (Nike Matriz) - /nike-matriz/*
‚îÇ   ‚îî‚îÄ‚îÄ üè™ FRANQUIA (Nike Loja Outlet) - /nike-outlet/*
‚îî‚îÄ‚îÄ üè¨ FRANQUEADOR (McDonald's Matriz) - /mcdonalds-matriz/*
    ‚îî‚îÄ‚îÄ üè™ FRANQUIA (McDonald's Loja Pra√ßa) - /mcdonalds-praca/*
```

### üéØ N√≠veis de Acesso

#### üëë **CROWN (Crown Company)**
- **URL**: `/crown/auth/login`
- **Visibilidade**: **TUDO** sem filtros
- **Funcionalidades**:
  - Sele√ß√£o de marca espec√≠fica
  - Sele√ß√£o de segmento
  - Relat√≥rios globais e consolidados
  - Administra√ß√£o de todos os tenants

#### üè¨ **FRANQUEADOR (ex: Lacoste Matriz)**
- **URL**: `/lacoste-matriz/auth/login`
- **Visibilidade**: **Todas as lojas da sua marca**
- **Funcionalidades**:
  - V√™ todos os chamados de suas franquias
  - BI consolidado da marca
  - Gerenciamento de franquias
  - Configura√ß√µes da marca

#### üè™ **FRANQUIA (ex: Lacoste Loja Shopping)**
- **URL**: `/lacoste-shopping/auth/login`
- **Visibilidade**: **Apenas seus pr√≥prios dados**
- **Funcionalidades**:
  - V√™ apenas chamados da sua loja
  - BI espec√≠fico da loja
  - Gerenciamento local
  - Configura√ß√µes da loja

## üé® Segmenta√ß√£o de Mercado

### üìÇ Segmentos Dispon√≠veis

- **üëó MODA** - Lacoste, Nike, Adidas, Zara, etc.
- **üçî FOOD** - McDonald's, Burger King, KFC, etc.
- **üíä FARMA** - Drogasil, Raia, Pacheco, etc.
- **üíª TECH** - Apple Store, Samsung, etc.
- **üíÑ BEAUTY** - Sephora, O Botic√°rio, etc.
- **‚öΩ SPORT** - Centauro, Decathlon, etc.
- **üì¶ OTHER** - Outros segmentos

### üéØ Funcionalidades por Segmento

- **Categoriza√ß√£o autom√°tica** de tickets
- **Relat√≥rios segmentados** para Crown
- **Configura√ß√µes espec√≠ficas** por segmento
- **Templates personalizados** por mercado

## üè∑Ô∏è Categoriza√ß√£o Flex√≠vel
- **Categorias personalizadas** por tenant
- **Cores e √≠cones** customiz√°veis
- **SLA espec√≠fico** por categoria
- **Heran√ßa de configura√ß√µes** do franqueador

## üåê CORS Configurado
A API est√° configurada para aceitar requisi√ß√µes de frontends rodando em:
- `http://localhost:3000` (React/Next.js)
- `http://localhost:3001` (React alternativo)
- `http://localhost:5173` (Vite)
- `http://localhost:5174` (Vite alternativo)
- `http://localhost:8080` (Vue.js)
- `http://localhost:4200` (Angular)
- `http://127.0.0.1:*` (Localhost alternativo)

## üß™ Testes e Desenvolvimento

### Comandos Dispon√≠veis

```bash
# Desenvolvimento
npm run start:dev

# Produ√ß√£o
npm run start:prod

# Testes
npm run test
npm run test:watch
npm run test:cov
npm run test:e2e

# Linting
npm run lint
npm run lint:fix

# Formata√ß√£o
npm run format

# Banco de dados
npx prisma studio
npx prisma migrate dev
npx prisma db push
npx prisma generate
```

## üìÑ Licen√ßa

Este projeto est√° sob a licen√ßa MIT - veja o arquivo LICENSE para detalhes.

## ü§ù Contribuindo

Contribui√ß√µes s√£o bem-vindas! Por favor, leia o arquivo CONTRIBUTING.md para detalhes sobre como contribuir.

## üìû Suporte

Para suporte, entre em contato atrav√©s dos issues do GitHub ou email: suporte@seudominio.com

---

**Desenvolvido com ‚ù§Ô∏è usando NestJS, Prisma e PostgreSQL**
